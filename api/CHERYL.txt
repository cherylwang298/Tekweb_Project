      // form.addEventListener("submit", async function (e) {
      //   e.preventDefault();
      //   const books = getBooks();
      //   const bookId = document.getElementById("book-id").value;
      //   const coverFile = coverInput.files[0]; // Ambil file dari input
      //   let coverBase64 = "";

      //   if (coverFile) {
      //     // Konversi file ke Base64 jika ada file baru
      //     coverBase64 = await convertToBase64(coverFile);
      //   }

      //   const newBook = {
      //     judul: document.getElementById("judul").value,
      //     penulis: document.getElementById("penulis").value,
      //     status: document.getElementById("status").value,
      //     catatan: document.getElementById("catatan").value,
      //     // Gunakan coverBase64 jika ada, jika tidak, akan dihandle di logika UPDATE/CREATE
      //     cover: coverBase64,
      //   };

      //   if (bookId) {
      //     // UPDATE
      //     const index = books.findIndex((b) => b.id === parseInt(bookId));
      //     if (index !== -1) {
      //       // Penting: Jika tidak ada file baru (coverBase64 kosong), pertahankan cover yang lama.
      //       newBook.cover = coverBase64 || books[index].cover;
      //       books[index] = { ...books[index], ...newBook };
      //     }
      //   } else {
      //     // CREATE
      //     const newId =
      //       books.length > 0 ? Math.max(...books.map((b) => b.id)) + 1 : 1;
      //     newBook.id = newId;
      //     // Jika membuat baru dan tidak ada cover, set ke string kosong
      //     if (!newBook.cover) newBook.cover = "";
      //     books.push(newBook);
      //   }

      //   saveBooks(books);
      //   closeModal(bookModal);
      //   renderBooks();
      // });

   // function deleteBook(id) {
      //   let books = getBooks();
      //   books = books.filter((book) => book.id !== id);
      //   saveBooks(books);
      //   renderBooks();
      // }


      // function openEditModal(id) {
      //   const books = getBooks();
      //   const bookToEdit = books.find((book) => book.id === id);

      //   if (bookToEdit) {
      //     modalTitle.textContent = "Edit Book: " + bookToEdit.judul;
      //     document.getElementById("book-id").value = bookToEdit.id;
      //     document.getElementById("judul").value = bookToEdit.judul;
      //     document.getElementById("penulis").value = bookToEdit.penulis;
      //     document.getElementById("status").value = bookToEdit.status;
      //     document.getElementById("catatan").value = bookToEdit.catatan;

      //     // Tampilkan Cover lama di preview (NEW)
      //     coverInput.value = ""; // Kosongkan input file
      //     if (bookToEdit.cover) {
      //       previewImg.src = bookToEdit.cover;
      //       coverPreview.classList.remove("hidden");
      //     } else {
      //       previewImg.src = "";
      //       coverPreview.classList.add("hidden");
      //     }

      //     openModal(bookModal);
      //   }
      // }


        <!-- <div class="mb-6 border-t pt-4 border-light-gray">
            <label for="cover" class="block mb-1 font-semibold"
              >Cover Image (Optional):</label
            >
            <input
              type="file"
              id="cover"
              name="cover"
              accept="image/*"
              class="w-full p-2 border border-light-gray rounded-md box-border focus:ring-accent-dark focus:border-accent-dark text-sm"
            />
            <div
              id="cover-preview"
              class="mt-2 w-20 h-20 border border-light-gray rounded-md bg-gray-100 flex items-center justify-center overflow-hidden hidden"
            >
              <img
                id="preview-img"
                class="max-w-full max-h-full object-cover"
                alt="Cover Preview"
              />
            </div>
          </div> -->


     // NEW: Cover Elements
      // const coverInput = document.getElementById("cover");
      // const coverPreview = document.getElementById("cover-preview");
      // const previewImg = document.getElementById("preview-img");\


       // Event listener untuk Cover Preview (NEW)
      coverInput.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            previewImg.src = e.target.result;
            coverPreview.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        } else {
          // Jika file dibatalkan atau dihapus
          coverPreview.classList.add("hidden");
          previewImg.src = "";
          // Jika sedang mode edit, tampilkan cover lama (jika ada)
          const bookId = document.getElementById("book-id").value;
          if (bookId) {
            const books = getBooks();
            const bookToEdit = books.find(
              (book) => book.id === parseInt(bookId)
            );
            if (bookToEdit && bookToEdit.cover) {
              previewImg.src = bookToEdit.cover;
              coverPreview.classList.remove("hidden");
            }
          }
        }
      });


         // Modal Hapus (DELETE)
      function openDeleteModal(id) {
        bookIdToDelete = id;
        const books = getBooks();
        const book = books.find((b) => b.id === id);
        document.getElementById("book-title-to-delete").textContent = book
          ? book.judul
          : "Unknown";

        openModal(deleteModal);
      }


            // function saveBooks(books) {
      //   localStorage.setItem("biblios_books", JSON.stringify(books));
      // }

           function openCreateModal() {
        modalTitle.textContent = "Add New Book";
        form.reset();
        document.getElementById("book-id").value = "";
        coverInput.value = "";
        previewImg.src = "";
        coverPreview.classList.add("hidden"); // Sembunyikan preview
        openModal(bookModal);
      }

          function closeModal(modalEl) {
        modalEl.classList.add("hidden");
        // Reset input file dan preview saat modal ditutup
        coverInput.value = "";
        previewImg.src = "";
        coverPreview.classList.add("hidden");
        form.reset();
      }

        <div class="mb-4">
            <label for="catatan" class="block mb-1 font-semibold"
              >Notes (Optional):</label
            >
            <textarea
              id="catatan"
              name="catatan"
              rows="3"
              class="w-full p-2 border border-light-gray rounded-md box-border resize-none focus:ring-accent-dark focus:border-accent-dark"
            ></textarea>
          </div>

  document.getElementById("catatan").value = bookToEdit.notes || "";

  // li.onclick = () => {
    //   titleInput.value = book.title;
    //   authorInput.value = book.author;
    //   dropdown.classList.add("hidden");
    // };

    
          // <button onclick="openReadModal(${book.reading_id})"
          //   class="text-gray-500 hover:text-yellow-500 transition duration-200 flex items-center gap-1">
          //    <i class="fas fa-star text-sm"></i>
          //   Read
          // </button>


















    <script>
      // DOM Elements
      const bookGrid = document.getElementById("book-grid");
      const bookModal = document.getElementById("book-modal");
      const deleteModal = document.getElementById("delete-modal");
      const form = document.getElementById("book-form");
      const modalTitle = document.getElementById("modal-title");
      const openModalBtn = document.getElementById("open-modal-btn");
      const closeBtns = document.querySelectorAll(".close-btn");
      const filterBtns = document.querySelectorAll(".filter-btn");
      const confirmDeleteBtn = document.getElementById("confirm-delete-btn");
      const cancelDeleteBtn = document.getElementById("cancel-delete-btn");
      const editStatusModal = document.getElementById('edit-status-modal');
      const editForm = document.getElementById('edit-status-form');
      // const rateButton = document.getElementById("btn-rate-book");
      const rateButton = document.getElementById("btn-rate-modal");
      if (rateButton) {
        rateButton.addEventListener("click", () => {
          document.getElementById("rating-form").classList.remove("hidden");
        });
      }

      const currentUserId = <?= json_encode($_SESSION['user_id']) ?>;

      const titleInput = document.getElementById("judul");
      const authorInput = document.getElementById("penulis");
      const dropdown = document.getElementById("title-dropdown");

      // Mobile Menu Elements
      const menuButton = document.getElementById("menu-button");
      const mobileMenu = document.getElementById("mobile-menu");

      // Event listener untuk Mobile Menu (NEW)
      menuButton.addEventListener("click", () => {
        mobileMenu.classList.toggle("hidden");
      });

      let currentFilter = "all";
      let bookIdToDelete = null;

      function showToast(message, type = "error") {
  const toast = document.getElementById("toast");
  toast.textContent = message;

  // ganti warna background sesuai type
  toast.className = `fixed top-5 right-5 px-4 py-2 rounded-lg shadow-lg opacity-100 transition-opacity duration-300 z-50 ${
    type === "error" ? "bg-red-500" : "bg-green-500"
  }`;

  // hide otomatis setelah 2.5 detik
  setTimeout(() => {
    toast.classList.remove("opacity-100");
    toast.classList.add("opacity-0");
  }, 2500);
}

function closeRatingModal() {
  const ratingModal = document.getElementById("details-modal");
  ratingModal.classList.add("hidden");
}

      // --- Utility Functions ---
     async function getBooks() {
       const res = await fetch("get_reading_lists.php");

  if (!res.ok) {
    console.error("Failed to fetch reading list");
    return [];
  }

  return await res.json();
      }

      function getStatusClasses(status) {
        switch (status) {
          case "finished":
            return "bg-success-bg text-success border border-success";
          case "reading":
            return "bg-info-bg text-info border border-info";
          case "to_read":
            return "bg-warning-bg text-warning border border-warning";
          default:
            return "bg-light-gray text-gray-600 border border-gray-400";
        }
      }

      function displayStatus(status) {
        switch (status) {
          case "finished":
            return "Finished";
          case "reading":
            return "Reading";
          case "to_read":
            return "To Read";
          default:
            return "Unknown";
        }
      }

      function convertToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      function getUrlParameter(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        const regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        const results = regex.exec(location.search);
        return results === null
          ? ""
          : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      // --- CRUD READ & Filter ---
      async function renderBooks() {
       const allBooks = await getBooks();

  const filteredBooks =
    currentFilter === "all"
      ? allBooks
      : allBooks.filter(book => book.status === currentFilter);

  bookGrid.innerHTML = "";

  if (filteredBooks.length === 0) {
    bookGrid.innerHTML = `
      <p class="col-span-full text-center p-12 text-gray-500">
        No books in this category.
      </p>`;
    return;
  }

  filteredBooks.forEach(book => {
    const statusClasses = getStatusClasses(book.status);

    const cover = book.book_cover
      ? `<img src="${book.book_cover}" class="w-full h-full object-cover">`
      : `<span class="text-sm text-gray-500">No Cover</span>`;

    bookGrid.innerHTML += `
      <div class="bg-white rounded-lg shadow-md p-5 flex flex-col">
        <div class="text-xs font-semibold px-3 py-1 rounded-md w-fit ${statusClasses}">
          ${displayStatus(book.status)}
        </div>

        <div class="w-full h-40 bg-light-gray rounded-md my-3 flex items-center justify-center overflow-hidden">
          ${cover}
        </div>

        <h3 class="font-serif text-xl text-accent-dark">
          ${book.title}
        </h3>

        <p class="text-sm text-gray-600 mb-2">
          By ${book.author}
        </p>

        <div class="mt-auto pt-3 flex gap-3">
          <button onclick="openEditModal(${book.reading_id})"
            class="text-gray-500 hover:text-accent-dark transition mr-3">
              <i class="fas fa-pencil-alt text-sm"></i>
            Edit
          </button>

          <button onclick="openDeleteModal(${book.reading_id})"
            class="text-gray-500 hover:text-red-600 transition">
             <i class="fas fa-trash-alt text-sm"></i>
            Delete
          </button>

          <button onclick="openDetailsModal(${book.reading_id})" class="btn-rate-book bg-accent-dark text-white py-2 px-4 rounded-md font-semibold text-xs hover:bg-[#0E3C40] transition">
                    Rate This Book
                </button>
        </div>
      </div>
    `;
  });
      }


      function openDetailsModal(id){
        document.getElementById("details-modal").dataset.bookId = id;
        document.getElementById("details-modal").classList.remove("hidden");
      }

      bookGrid.addEventListener("click", (e)=> {
        if (e.target.classList.contains("btn-rate-book")) {
          const bookId = e.target.dataset.bookId;

          document.getElementById("details-modal").dataset.bookId = bookId;
          document.getElementById("rating-form").classList.remove("hidden");

          loadUserRating(bookId);
        }
      })

      // // --- CRUD CREATE
//craye
  form.addEventListener("submit", async function (e) {
  e.preventDefault();

  const formData = new FormData(form);
  for (const [key, value] of formData.entries()) {
  console.log(key, value);
}

  const res = await fetch("add_to_readlist.php", {
    method: "POST",
    body: formData,
  });

  const result = await res.json();

  if (!result.success) {
    alert(result.message || "Failed to save book");
    showToast(result.message, "error")
    return;
  }

  showToast("Book added successfully", "success")
  closeModal(bookModal);
  renderBooks();
});

  // update status:
editForm.addEventListener("submit", async function(e) {
  e.preventDefault();
  const formData = new FormData(editForm);

  const res = await fetch("edit_status.php", {
    method: "POST",
    body: formData
  });

  const result = await res.json();
  if (!result.success) {
    alert(result.message || "Failed to update book");
    return;
  }

  closeModal(editStatusModal);
  renderBooks();
});

      // --- CRUD DELETE (Menggunakan Modal) ---
  async function deleteBook(id) {
  const res = await fetch("deleteBook_readingList.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id }),
  });

  const result = await res.json();

  if (!result.success) {
    // alert("Failed to delete book");
    showToast("Failed to delete book", "error")
    return;
  }

  showToast('Book deleted successfully', 'success')
  renderBooks();
}

  //fungsi delete book dari readlin g list + back
      confirmDeleteBtn.addEventListener("click", () => {
        if (bookIdToDelete !== null) {
          deleteBook(bookIdToDelete);
          closeModal(deleteModal);
        }
      });

      cancelDeleteBtn.addEventListener("click", () => {
        closeModal(deleteModal);
      });



  // Filtering sesuai status
  filterBtns.forEach((btn) => {
    btn.addEventListener("click", function () {
      filterBtns.forEach((b) =>
        b.classList.remove(
          "active-filter",
          "border-accent-dark",
          "bg-accent-dark/10"
        )
      );
      this.classList.add(
        "active-filter",
        "border-accent-dark",
        "bg-accent-dark/10"
      );

      currentFilter = this.dataset.filter;
      renderBooks();
    });
  });

  // Buka tutup modal
  function openModal(modalEl) {
    modalEl.classList.remove("hidden");
  }

  function closeModal(modalEl) {
    modalEl.classList.add("hidden");
    //form.reset();
  }


  //ini buka tutup modal function:
      // Add Book modal (open)
      openModalBtn.addEventListener("click", () => openCreateModal());

      // Tutup modal ------> buat fungsi buat semua modal sekalian
      closeBtns.forEach((btn) =>
        btn.addEventListener("click", () => {
          closeModal(bookModal);
          closeModal(deleteModal);
          closeModal(editStatusModal);
        })
      );

      window.addEventListener("click", (event) => {
        if (event.target == bookModal) closeModal(bookModal);
        if (event.target == editStatusModal) closeModal(editStatusModal);
        if (event.target == deleteModal) closeModal(deleteModal);
      });

      // Modal Tambah (CREATE)
      function openCreateModal() {
        modalTitle.textContent = "Add New Book";
        form.reset();
        document.getElementById("book-id").value = "";
        openModal(bookModal);
      }

      // Modal Edit -> open
      async function openEditModal(id) {
        const books = await getBooks();
        const bookToEdit = books.find((book) => book.reading_id === id);

        if (!bookToEdit) return;

        modalTitle.textContent = "Edit Book: " + bookToEdit.title;
        document.getElementById("book-idEdit").value = bookToEdit.reading_id;
        document.getElementById("judulEdit").value = bookToEdit.title;
        document.getElementById("penulisEdit").value = bookToEdit.author;
        document.getElementById("statusEdit").value = bookToEdit.status;

        if (bookToEdit.book_cover) {
          previewImg.src = bookToEdit.book_cover;
          coverPreview.classList.remove("hidden");
        }

        openModal(editStatusModal);
      }


    //open delete modal
      async function openDeleteModal(id) {
        bookIdToDelete = id;
        const books = await getBooks();
        const book = books.find(b => b.reading_id === id);

        document.getElementById("book-title-to-delete").textContent =
        book ? book.title : "Unknown";

        openModal(deleteModal);
      }


  // aautocom
  titleInput.addEventListener("input", async () => {
  const q = titleInput.value.trim();

  if (q.length < 2) {
    dropdown.classList.add("hidden");
    dropdown.innerHTML = "";
    return;
  }

  const res = await fetch(`search_books.php?q=${encodeURIComponent(q)}`);
  const books = await res.json();

  dropdown.innerHTML = "";

  if (books.length === 0) {
    dropdown.classList.add("hidden");
    return;
  }

  books.forEach(book => {
    const li = document.createElement("li");
    li.textContent = `${book.title} â€” ${book.author}`;
    li.className = "px-3 py-2 hover:bg-light-gray cursor-pointer";

    li.onclick = () => {
  titleInput.value = book.title;
  authorInput.value = book.author;

  document.getElementById("book-id-selected").value = book.id;

  dropdown.classList.add("hidden");
};


    dropdown.appendChild(li);
  });

  dropdown.classList.remove("hidden");
});





      // Inisialisasi: Tampilkan semua buku saat halaman dimuat
      document.addEventListener("DOMContentLoaded", () => {
        // NEW LOGIC: Cek filter dari URL
        const filterFromUrl = getUrlParameter("filter");

        if (filterFromUrl) {
          currentFilter = filterFromUrl;

          // Hapus penyorotan default
          const allButton = document.querySelector(
            '.filter-btn[data-filter="Semua"]'
          );
          if (allButton) {
            allButton.classList.remove(
              "active-filter",
              "border-accent-dark",
              "bg-accent-dark/10"
            );
          }

          // Terapkan penyorotan pada tombol filter yang sesuai
          const targetButton = document.querySelector(
            `.filter-btn[data-filter="${currentFilter}"]`
          );
          if (targetButton) {
            targetButton.classList.add(
              "active-filter",
              "border-accent-dark",
              "bg-accent-dark/10"
            );
          }
        } else {
          // Logika default jika tidak ada filter di URL
          const allButton = document.querySelector(
            '.filter-btn[data-filter="Semua"]'
          );
          if (allButton) {
            allButton.classList.add(
              "active-filter",
              "border-accent-dark",
              "bg-accent-dark/10"
            );
          }
        }

        renderBooks();
      });




  
   // LOAD USER RATING
    async function loadUserRating(bookId) {
        const res = await fetch(`get_user_rating.php?book_id=${bookId}&user_id=${currentUserId}`);
        const data = await res.json();

        const rateButton = document.getElementById("btn-rate-modal");
        const ratingForm = document.getElementById("rating-form");

        if (!data || data.rating === null) {
            // User hasn't rated: show button, hide form
            rateButton.classList.remove("hidden");
            ratingForm.classList.add("hidden");
            return;
        }

        // User already rated: hide button and form
        rateButton.classList.add("hidden");
        ratingForm.reset();               
        ratingForm.classList.add("hidden");
    }


     // USER CLICKS RATE -> SHOW FORM
    document.getElementById("btn-rate-modal").addEventListener("click", () => {
        document.getElementById("rating-form").classList.remove("hidden");
    });


    // SUBMITTING RATING / REVIEW
    document.getElementById("rating-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const ratingInput = document.getElementById("user-rating").value;
        const rating = ratingInput === "" ? null : parseFloat(ratingInput);
        const review = document.getElementById("user-review").value;
        const bookId = document.getElementById("details-modal").dataset.bookId;

        const formData = new FormData();
        formData.append("user_id", currentUserId);
        formData.append("book_id", bookId);
        formData.append("rating", rating);
        formData.append("review", review);

        const res = await fetch("rate_book.php", {
            method: "POST",
            body: formData,
        });

        const data = await res.json();

        if (!data.success) {
            alert(data.message || "Failed to submit review");
            return;
        }

        // After submit:
        document.getElementById("rating-form").classList.add("hidden");
        // document.getElementByClassName("btn-rate-book").classList.add("hidden");
        document.querySelectorAll(".btn-rate-book").forEach((button) => {
          btn.classList.add("hidden");
        })

        // Reload modal content
        openDetailsModal(bookId);
    });


    </script>









    getUrlParameter
    <script>

/* =====================================================
   GLOBAL DOM ELEMENTS
===================================================== */
const bookGrid = document.getElementById("book-grid");
const bookModal = document.getElementById("book-modal");
const deleteModal = document.getElementById("delete-modal");
const editStatusModal = document.getElementById("edit-status-modal");

const form = document.getElementById("book-form");
const editForm = document.getElementById("edit-status-form");

const modalTitle = document.getElementById("modal-title");
const openModalBtn = document.getElementById("open-modal-btn");
const closeBtns = document.querySelectorAll(".close-btn");

const filterBtns = document.querySelectorAll(".filter-btn");
const confirmDeleteBtn = document.getElementById("confirm-delete-btn");
const cancelDeleteBtn = document.getElementById("cancel-delete-btn");

const rateModalBtn = document.getElementById("btn-rate-modal");
const ratingForm = document.getElementById("rating-form");

const titleInput = document.getElementById("judul");
const authorInput = document.getElementById("penulis");
const dropdown = document.getElementById("title-dropdown");

const currentUserId = <?= json_encode($_SESSION['user_id']) ?>;

let currentFilter = "all";
let bookIdToDelete = null;


/* =====================================================
   TOAST
===================================================== */
function showToast(message, type = "error") {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.className = `fixed top-5 right-5 px-4 py-2 rounded-lg shadow-lg opacity-100 transition z-50 ${
    type === "error" ? "bg-red-500" : "bg-green-500"
  }`;

  setTimeout(() => {
    toast.classList.remove("opacity-100");
    toast.classList.add("opacity-0");
  }, 2500);
}


/* =====================================================
   FETCH DATA
===================================================== */
async function getBooks() {
  const res = await fetch("get_reading_lists.php");
  if (!res.ok) return [];
  return await res.json();
}


/* =====================================================
   STATUS HELPERS
===================================================== */
function getStatusClasses(status) {
  if (status === "finished") return "bg-success-bg text-success border border-success";
  if (status === "reading") return "bg-info-bg text-info border border-info";
  if (status === "to_read") return "bg-warning-bg text-warning border border-warning";
  return "bg-light-gray text-gray-600 border border-gray-400";
}

function displayStatus(status) {
  if (status === "finished") return "Finished";
  if (status === "reading") return "Reading";
  if (status === "to_read") return "To Read";
  return "Unknown";
}


/* =====================================================
   RENDER BOOKS
===================================================== */
async function renderBooks() {
  const allBooks = await getBooks();
  const books = currentFilter === "all"
    ? allBooks
    : allBooks.filter(b => b.status === currentFilter);

  bookGrid.innerHTML = "";

  if (books.length === 0) {
    bookGrid.innerHTML = <p class="col-span-full text-center text-gray-500">No books found</p>;
    return;
  }

  books.forEach(book => {
    const cover = book.book_cover
      ? <img src="${book.book_cover}" class="w-full h-full object-cover">
      : <span class="text-gray-500 text-sm">No Cover</span>;

    bookGrid.innerHTML += `
      <div class="bg-white rounded-lg shadow-md p-5 flex flex-col">
        <div class="text-xs font-semibold px-3 py-1 rounded-md w-fit ${getStatusClasses(book.status)}">
          ${displayStatus(book.status)}
        </div>

        <div class="w-full h-40 bg-light-gray my-3 flex items-center justify-center overflow-hidden">
          ${cover}
        </div>

        <h3 class="font-serif text-xl text-accent-dark">${book.title}</h3>
        <p class="text-sm text-gray-600 mb-3">By ${book.author}</p>

        <div class="mt-auto flex gap-3">
          <button onclick="openEditModal(${book.reading_id})" class="text-gray-500 hover:text-accent-dark">
            Edit
          </button>
          <button onclick="openDeleteModal(${book.reading_id})" class="text-gray-500 hover:text-red-600">
            Delete
          </button>
          <button onclick="openDetailsModal(${book.reading_id})"
            class="bg-accent-dark text-white px-3 py-2 rounded text-xs">
            Rate This Book
          </button>
        </div>
      </div>
    `;
  });
}


/* =====================================================
   DETAILS & RATING
===================================================== */
function openDetailsModal(bookId) {
  const modal = document.getElementById("details-modal");
  modal.dataset.bookId = bookId;
  modal.classList.remove("hidden");
  loadUserRating(bookId);
}

async function loadUserRating(bookId) {
  const res = await fetch(get_user_rating.php?book_id=${bookId}&user_id=${currentUserId});
  const data = await res.json();

  if (!data || data.rating === null) {
    rateModalBtn.classList.remove("hidden");
    ratingForm.classList.add("hidden");
  } else {
    rateModalBtn.classList.add("hidden");
    ratingForm.classList.add("hidden");
    ratingForm.reset();
  }
}

rateModalBtn.addEventListener("click", () => {
  ratingForm.classList.remove("hidden");
});

ratingForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const bookId = document.getElementById("details-modal").dataset.bookId;

  const formData = new FormData();
  formData.append("user_id", currentUserId);
  formData.append("book_id", bookId);
  formData.append("rating", document.getElementById("user-rating").value);
  formData.append("review", document.getElementById("user-review").value);

  const res = await fetch("rate_book.php", { method: "POST", body: formData });
  const data = await res.json();

  if (!data.success) {
    alert(data.message || "Failed to submit rating");
    return;
  }

  ratingForm.classList.add("hidden");
  rateModalBtn.classList.add("hidden");
  openDetailsModal(bookId);
});


/* =====================================================
   CREATE / EDIT / DELETE
===================================================== */
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const res = await fetch("add_to_readlist.php", { method: "POST", body: new FormData(form) });
  const data = await res.json();

  if (!data.success) {
    showToast(data.message, "error");
    return;
  }

  showToast("Book added", "success");
  bookModal.classList.add("hidden");
  renderBooks();
});

editForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  await fetch("edit_status.php", { method: "POST", body: new FormData(editForm) });
  editStatusModal.classList.add("hidden");
  renderBooks();
});

async function openDeleteModal(id) {
  bookIdToDelete = id;
  deleteModal.classList.remove("hidden");
}

confirmDeleteBtn.addEventListener("click", async () => {
  await fetch("deleteBook_readingList.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id: bookIdToDelete })
  });
  deleteModal.classList.add("hidden");
  renderBooks();
});

cancelDeleteBtn.addEventListener("click", () => deleteModal.classList.add("hidden"));


/* =====================================================
   FILTER
===================================================== */
filterBtns.forEach(btn => {
  btn.addEventListener("click", () => {
    filterBtns.forEach(b => b.classList.remove("active-filter"));
    btn.classList.add("active-filter");
    currentFilter = btn.dataset.filter;
    renderBooks();
  });
});


/* =====================================================
   INIT
===================================================== */
document.addEventListener("DOMContentLoaded", renderBooks);
</script>





RATINGAN

 // RATING FILTER (STAR BUTTONS)
    const ratingButtons = document.querySelectorAll(".rating-btn");

    ratingButtons.forEach(button => {
        button.addEventListener("click", () => {

            // Reset all buttons
            ratingButtons.forEach(b => {
                b.classList.remove("bg-accent-dark", "text-white");
                b.classList.add("text-gray-500");
            });

            // Activate clicked button
            button.classList.add("bg-accent-dark", "text-white");
            button.classList.remove("text-gray-500");

            const value = button.dataset.rating;

            // Show all books
            if (value === "all") {
                renderBooks(window.allBooks);
                return;
            }

            const minRating = parseFloat(value);

            const filtered = window.allBooks.filter(b => {
                const rating = parseFloat(b.avg_rating);
                return !isNaN(rating) && rating >= minRating;
            });

            renderBooks(filtered);
        });
    });

// LOAD USER RATING
    async function loadUserRating(bookId) {
        const res = await fetch(`get_user_rating.php?book_id=${bookId}&user_id=${currentUserId}`);
        const data = await res.json();

        const rateButton = document.getElementById("btn-rate-book");
        const ratingForm = document.getElementById("rating-form");

        if (!data || data.rating === null) {
            // User hasn't rated: show button, hide form
            rateButton.classList.remove("hidden");
            ratingForm.classList.add("hidden");
            return;
        }

        // User already rated: hide button and form
        rateButton.classList.add("hidden");
        ratingForm.reset();               
        ratingForm.classList.add("hidden");
    }

    // USER CLICKS RATE -> SHOW FORM
    document.getElementById("btn-rate-book").addEventListener("click", () => {
        document.getElementById("rating-form").classList.remove("hidden");
        initHalfStarRating(); // show star rating
    });

    /* ----------------------------------------------------
    HALF STAR RATING (REUSABLE)
    ---------------------------------------------------- */
    function initHalfStarRating(containerId = "star-rating") {
        const container = document.getElementById(containerId);
        if (!container) return;

        const stars = container.querySelectorAll(".star");
        const hiddenInput = container.querySelector("#user-rating");
        const preview = container.querySelector("#rating-preview");

        let lockedRating = 0;

        function render(rating) {
            stars.forEach(star => {
                const value = parseInt(star.dataset.value);
                const empty = star.querySelector(".star-empty");
                const half = star.querySelector(".star-half");
                const full = star.querySelector(".star-full");

                empty.style.display = "block";
                half.style.display = "none";
                full.style.display = "none";

                if (rating >= value) {
                    empty.style.display = "none";
                    full.style.display = "block";
                } else if (rating === value - 0.5) {
                    empty.style.display = "block";
                    half.style.display = "block";
                }
            });

            preview.textContent = `${rating.toFixed(1)} / 5.0`;
        }

        stars.forEach(star => {
            const value = parseInt(star.dataset.value);

            star.addEventListener("mousemove", e => {
                const rect = star.getBoundingClientRect();
                const isLeft = e.clientX < rect.left + rect.width / 2;
                render(isLeft ? value - 0.5 : value);
            });

            star.addEventListener("mouseleave", () => {
                render(lockedRating);
            });

            star.addEventListener("click", e => {
                const rect = star.getBoundingClientRect();
                const isLeft = e.clientX < rect.left + rect.width / 2;

                lockedRating = isLeft ? value - 0.5 : value;
                hiddenInput.value = lockedRating;
                render(lockedRating);
            });
        });

        render(0);
    }

    // SUBMITTING RATING / REVIEW
    document.getElementById("rating-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const ratingInput = document.getElementById("user-rating").value;
        const rating = ratingInput === "" ? null : parseFloat(ratingInput);
        const review = document.getElementById("user-review").value;
        const bookId = document.getElementById("details-modal").dataset.bookId;

        const formData = new FormData();
        formData.append("user_id", currentUserId);
        formData.append("book_id", bookId);
        formData.append("rating", rating);
        formData.append("review", review);

        const res = await fetch("rate_book.php", {
            method: "POST",
            body: formData,
        });

        const data = await res.json();

        if (!data.success) {
            alert(data.message || "Failed to submit review");
            return;
        }

        // After submit:
        document.getElementById("rating-form").classList.add("hidden");
        document.getElementById("btn-rate-book").classList.add("hidden");

        // Reload modal content
        openDetailsModal(bookId);
    });


    rate_book.php|
    <?php
session_start();
require_once "db.php";

$user_id = $_SESSION['user_id'] ?? 0;
$book_id = $_POST['book_id'];
$rating  = $_POST['rating'];
$review  = $_POST['review'];

if (!$user_id || !$book_id) {
    echo json_encode(["success" => false, "message" => "Missing user_id or book_id"]);
    exit;
}

$sql = "
    INSERT INTO ratings (user_id, book_id, rating, review)
    VALUES (?, ?, ?, ?)
    ON DUPLICATE KEY UPDATE 
        rating = VALUES(rating),
        review = VALUES(review),
        created_at = CURRENT_TIMESTAMP
";

$stmt = $conn->prepare($sql);
$stmt->bind_param("iids", $user_id, $book_id, $rating, $review);
$stmt->execute();

echo json_encode(["success" => true]);
?> 


SEBELUM GANTI

add_book.php
<?php
require_once "db.php";

// Input
$title = $_POST['title'];
$author = $_POST['author'];
$synopsis = $_POST['synopsis'];
$book_cover = $_POST['book_cover']; // URL

// Cek duplikasi
$check = $conn->prepare("SELECT id FROM books WHERE title=? AND author=?");
$check->bind_param("ss", $title, $author);
$check->execute();
$check->store_result();

if ($check->num_rows > 0) {
    echo json_encode(["success" => false, "message" => "Book already exists"]);
    exit;
}

$stmt = $conn->prepare("INSERT INTO books (title, author, synopsis, book_cover) VALUES (?, ?, ?, ?)");
$stmt->bind_param("ssss", $title, $author, $synopsis, $book_cover);
$stmt->execute();

echo json_encode(["success" => true, "id" => $stmt->insert_id]);


